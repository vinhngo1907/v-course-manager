generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Supporter {
    id     String @id @default(uuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Admin {
    id     String @id @default(uuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Mod {
    id     String @id @default(uuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Account {
    id          String   @id @default(uuid())
    username    String   @unique @db.VarChar(20)
    password    String   @db.VarChar(200)
    isActivated Boolean  @default(true)
    user        User?
    userId      String?  @db.Uuid
    createdAt   DateTime @default(now())
    createdBy   String   @default("system")
    updatedAt   DateTime @updatedAt
    updatedBy   String   @default("system")
}

model User {
    id       String @id @default(uuid())
    email    String @unique @db.VarChar(255)
    fullName String @db.VarChar(255)
    avatar   String @default("https://res.cloudinary.com/v-webdev/image/upload/v1661947123/v-chat-app/profile-user_p2khhu.png")

    roles       Role[]
    modId       String?
    mod         Mod?
    adminId     String?
    admin       Admin?
    supporterId String?
    supporter   Supporter?

    accountId String   @unique
    account   Account  @relation(fields: [accountId], references: [id])
    courses   Course[]
    videos    Video[]

    // streams Stream[]

    comments    Comment[]
    commentTags CommentTag[]

    userLessonProgress  UserLessonProgress?
    courseRegistrations CourseRegistration[]
    userVideoProgresses UserVideoProgress[]
}

model Role {
    id        String   @id @default(uuid())
    name      String   @unique @db.VarChar(200)
    users     User[]
    createdAt DateTime @default(now())
    createdBy String   @default("system")
    updatedAt DateTime @updatedAt
    updatedBy String   @default("system")
    isActive  Boolean  @default(true)
}

model Subtitle {
    id       String    @id @default(uuid())
    sublines Subline[]
    language String
    // videos   Video[]
    Video    Video?    @relation(fields: [videoId], references: [id])
    videoId  String?
}

model Subline {
    id         String    @id @default(uuid())
    content    String
    // subtitles Subtitle[]
    Subtitle   Subtitle? @relation(fields: [subtitleId], references: [id])
    subtitleId String?
    timestamp  DateTime  @default(now())
}

model Course {
    id                 String               @id @default(uuid())
    title              String               @db.VarChar(300)
    description        String               @db.VarChar(300)
    thumbnail          String?              @db.VarChar(300)
    lessons            Lesson[]
    CourseRegistration CourseRegistration[]

    createdById String
    createdBy   User    @relation(fields: [createdById], references: [id])
    published   Boolean @default(false)

    // streams Stream[]

    @@map("Course")
}

model Lesson {
    id             String               @id @default(uuid())
    name           String               @db.VarChar(300)
    description    String               @db.VarChar(300)
    course         Course               @relation(fields: [courseId], references: [id])
    courseId       String
    videos         Video[]
    usersCompleted UserLessonProgress[]
}

model CourseRegistration {
    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    courseId String
    course   Course @relation(fields: [courseId], references: [id])

    registeredAt DateTime @default(now())

    isCompleted Boolean  @default(false)
    completedAt DateTime?

    @@unique([userId, courseId])
    @@map("CourseRegistration")
}

model UserLessonProgress {
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String @unique

    lesson   Lesson @relation(fields: [lessonId], references: [id])
    lessonId String @unique

    isCompleted Boolean  @default(false)
    completedAt DateTime?

    // @@id([userId, lessonId])
    @@map("UserLessonProgress")
}

model UserVideoProgress {
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    videoId     String    @unique
    video       Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
    isCompleted Boolean   @default(false)
    completedAt DateTime?

    watchedSeconds Float    @default(0)
    duration       Float
    lastWatched    DateTime @updatedAt

    @@id([userId, videoId])
    @@index([userId])
    @@index([videoId])
}

model Video {
    id          String  @id @default(uuid())
    title       String  @db.VarChar(300)
    description String  @db.VarChar(300)
    thumbnail   String? @db.VarChar(300)
    videoUrl    String? @db.VarChar(300)
    position    Int

    subtitles Subtitle[]

    lesson   Lesson? @relation(fields: [lessonId], references: [id])
    lessonId String? @unique

    owner   User   @relation(fields: [ownerId], references: [id])
    ownerId String

    muxData MuxData?

    publishAt   DateTime  @default(now())
    duration    Float
    aspectRatio String?
    status      String    @default("preparing")
    posterTime  Float?
    comments    Comment[]

    // sourceStreams       Stream[]            @relation("SourceVideo")
    // recordedStreams     Stream[]            @relation("RecordedVideo")
    userVideoProgresses UserVideoProgress[]

    @@map("Video")
}

model MuxData {
    id         String  @id @default(uuid())
    assetId    String
    playbackId String?

    videoId String @unique
    video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)
}

model Comment {
    id      String @id @default(uuid())
    content String

    // lessonId String?
    // lesson   Lesson? @relation(fields: [lessonId], references: [id])

    videoId String?
    video   Video?  @relation(fields: [videoId], references: [id])

    authorId String
    author   User   @relation(fields: [authorId], references: [id])

    // âœ… REPLY: self reference
    parent   Comment? @relation("CommentReplies", fields: [parentId], references: [id])
    parentId String?

    replies Comment[] @relation("CommentReplies") // All reply

    likes    Int @default(0)
    dislikes Int @default(0)

    reactions CommentReactions[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Tag
    tags CommentTag[]

    @@map("Comment")
}

model CommentTag {
    id String @id @default(uuid())

    comment   Comment @relation(fields: [commentId], references: [id])
    commentId String

    tagged User   @relation(fields: [userId], references: [id])
    userId String
}

model CommentReactions {
    id        String   @id @default(uuid())
    type      String
    Comment   Comment? @relation(fields: [commentId], references: [id])
    commentId String?

    @@map("Comment_Reaction")
}

// enum StreamType {
//     WEBCAM
//     VIDEO
// }

// enum StreamStatus {
//     CREATED
//     LIVE
//     ENDED
//     ERROR
// }

// model Stream {
//     id           String  @id @default(uuid())
//     title        String  @db.VarChar(300)
//     description  String? @db.Text
//     thumbnailUrl String? @db.Text

//     ingressId String? @unique
//     serverUrl String? @db.Text
//     streamKey String? @db.Text

//     type   StreamType
//     status StreamStatus @default(CREATED)
//     isLive Boolean      @default(false)

//     isChatEnabled       Boolean @default(true)
//     isChatDelayed       Boolean @default(false)
//     isChatFollowersOnly Boolean @default(false)

//     userId String
//     user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

//     courseId String?
//     course   Course? @relation(fields: [courseId], references: [id])

//     sourceVideoId String?
//     sourceVideo   Video?  @relation("SourceVideo", fields: [sourceVideoId], references: [id])

//     recordedVideoId String?
//     recordedVideo   Video?  @relation("RecordedVideo", fields: [recordedVideoId], references: [id])

//     startedAt DateTime?
//     endedAt   DateTime?

//     createdAt DateTime @default(now())
//     updatedAt DateTime @updatedAt

//     @@index([userId])
//     @@index([courseId])
//     @@index([ingressId])
// }
